generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                         String            @id @default(cuid())
  name                       String?
  email                      String            @unique
  emailVerified              DateTime?
  password                   String?
  image                      String?
  bio                        String?
  role                       UserRole          @default(USER)
  createdAt                  DateTime          @default(now())
  updatedAt                  DateTime          @updatedAt
  measurementSystem          String            @default("imperial") // 'imperial' or 'metric'
  language                   String            @default("en") // 'en', 'es', 'fr', 'de'
  theme                      String            @default("light") // 'light', 'dark', 'auto'
  subscriptionTier           SubscriptionTier  @default(FREE)
  subscriptionStatus         String?
  stripeCustomerId           String?           @unique
  stripeSubscriptionId       String?           @unique
  subscriptionEndsAt         DateTime?
  trialEndsAt                DateTime?
  mealPlansThisMonth         Int               @default(0)
  aiQuestionsThisMonth       Int               @default(0)
  lastResetDate              DateTime          @default(now())
  imageGenerationsThisMonth  Int               @default(0)
  pdfExportsThisMonth        Int               @default(0)
  recipeGenerationsThisMonth Int               @default(0)
  termsAccepted              Boolean           @default(false)
  termsAcceptedAt            DateTime?
  privacyAccepted            Boolean           @default(false)
  privacyAcceptedAt          DateTime?
  accounts                   Account[]
  aiGenerationLogs           AIGenerationLog[]
  comments                   Comment[]
  favorites                  Favorite[]
  generatedRecipes           GeneratedRecipe[]
  mealPlans                  MealPlan[]
  planComments               MealPlanComment[]
  planLikes                  MealPlanLike[]
  planReports                MealPlanReport[]
  pantryItems                PantryItem[]
  progress                   Progress[]
  ratings                    Rating[]
  recipes                    Recipe[]
  savedPlans                 SavedMealPlan[]
  sessions                   Session[]
  shoppingLists              ShoppingList[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Recipe {
  id             String          @id @default(cuid())
  title          String
  description    String?
  ingredients    Json
  instructions   String
  prepTime       String?
  cookTime       String?
  servings       Int?
  defenseSystems DefenseSystem[]
  nutrients      Json?
  imageUrl       String?
  userId         String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  comments       Comment[]
  favorites      Favorite[]
  ratings        Rating[]
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model Rating {
  id        String   @id @default(cuid())
  value     Int
  recipeId  String
  userId    String
  createdAt DateTime @default(now())
  recipe    Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([recipeId, userId])
  @@index([recipeId])
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  recipeId  String
  userId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  recipe    Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([recipeId])
  @@index([userId])
}

model Favorite {
  id        String   @id @default(cuid())
  recipeId  String
  userId    String
  createdAt DateTime @default(now())
  recipe    Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([recipeId, userId])
  @@index([userId])
}

model Progress {
  id            String        @id @default(cuid())
  userId        String
  date          DateTime      @db.Date
  defenseSystem DefenseSystem
  foodsConsumed Json
  count         Int
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date, defenseSystem])
  @@index([userId, date])
}

model MealPlan {
  id                  String             @id @default(cuid())
  userId              String
  title               String
  description         String?
  weekStart           DateTime
  weekEnd             DateTime
  durationWeeks       Int                @default(1)
  defaultServings     Int                @default(2)
  visibility          MealPlanVisibility @default(PRIVATE)
  status              MealPlanStatus     @default(DRAFT)
  tags                String[]
  likes               Int                @default(0)
  saves               Int                @default(0)
  views               Int                @default(0)
  customInstructions  String?
  dietaryRestrictions String[]
  focusSystems        String[]
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  publishedAt         DateTime?
  dailyMenus          DailyMenu[]
  user                User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  comments            MealPlanComment[]
  likedBy             MealPlanLike[]
  reports             MealPlanReport[]
  savedBy             SavedMealPlan[]
  shoppingLists       ShoppingList[]

  @@index([userId])
  @@index([weekStart, weekEnd])
  @@index([visibility, status])
}

model DailyMenu {
  id         String   @id @default(cuid())
  mealPlanId String
  date       DateTime
  servings   Int?
  notes      String?
  mealPlan   MealPlan @relation(fields: [mealPlanId], references: [id], onDelete: Cascade)
  meals      Meal[]

  @@unique([mealPlanId, date])
  @@index([mealPlanId, date])
}

model Meal {
  id                 String           @id @default(cuid())
  dailyMenuId        String
  mealType           String
  mealName           String
  servings           Int?
  defenseSystems     String[]
  prepTime           String?
  cookTime           String?
  position           Int              @default(0)
  customInstructions String?
  recipeGenerated    Boolean          @default(false)
  recipeId           String?          @unique
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  generatedRecipe    GeneratedRecipe?
  dailyMenu          DailyMenu        @relation(fields: [dailyMenuId], references: [id], onDelete: Cascade)

  @@index([dailyMenuId, mealType])
}

model GeneratedRecipe {
  id             String   @id @default(cuid())
  userId         String
  mealId         String   @unique
  name           String
  description    String?
  servings       Int
  prepTime       String
  cookTime       String
  totalTime      String
  difficulty     String?
  ingredients    Json
  instructions   Json
  calories       Int?
  protein        Float?
  carbs          Float?
  fat            Float?
  fiber          Float?
  defenseSystems String[]
  tags           String[]
  isPublic       Boolean  @default(false)
  likes          Int      @default(0)
  saves          Int      @default(0)
  generatedBy    String?
  customPrompt   String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  meal           Meal     @relation(fields: [mealId], references: [id], onDelete: Cascade)
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isPublic])
}

model ShoppingList {
  id             String    @id @default(cuid())
  userId         String
  mealPlanId     String?
  title          String    @default("Shopping List")
  items          Json
  totalItems     Int
  totalCost      Float?
  currency       String?   @default("USD")
  pantryFiltered Boolean   @default(false)
  lastExported   DateTime?
  sourceType     String?   // 'meal-plans' or 'recipes'
  sourceIds      Json?     // Array of source IDs (meal plan IDs or recipe IDs)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  mealPlan       MealPlan? @relation(fields: [mealPlanId], references: [id], onDelete: Cascade)
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([mealPlanId])
}

model PantryItem {
  id            String    @id @default(cuid())
  userId        String
  name          String
  category      String
  quantity      Float?
  unit          String?
  alwaysHave    Boolean   @default(false)
  lowStockAlert Boolean   @default(false)
  expiresAt     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
  @@index([userId])
}

model SavedMealPlan {
  id         String   @id @default(cuid())
  userId     String
  mealPlanId String
  notes      String?
  createdAt  DateTime @default(now())
  mealPlan   MealPlan @relation(fields: [mealPlanId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, mealPlanId])
  @@index([userId])
}

model MealPlanLike {
  id         String   @id @default(cuid())
  userId     String
  mealPlanId String
  createdAt  DateTime @default(now())
  mealPlan   MealPlan @relation(fields: [mealPlanId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, mealPlanId])
  @@index([userId])
  @@index([mealPlanId])
}

model MealPlanComment {
  id         String   @id @default(cuid())
  userId     String
  mealPlanId String
  content    String
  edited     Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  mealPlan   MealPlan @relation(fields: [mealPlanId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([mealPlanId])
}

model MealPlanReport {
  id         String   @id @default(cuid())
  userId     String
  mealPlanId String
  reason     String
  details    String?
  status     String   @default("pending")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  mealPlan   MealPlan @relation(fields: [mealPlanId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
}

model FeatureFlag {
  id                String            @id @default(cuid())
  name              String            @unique
  description       String?
  enabled           Boolean           @default(false)
  requiredTier      SubscriptionTier?
  rolloutPercentage Int               @default(0)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
}

enum DefenseSystem {
  ANGIOGENESIS
  REGENERATION
  MICROBIOME
  DNA_PROTECTION
  IMMUNITY
}

enum SubscriptionTier {
  FREE
  PREMIUM
  FAMILY
}

enum MealPlanVisibility {
  PRIVATE
  PUBLIC
  FRIENDS
}

enum MealPlanStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum UserRole {
  USER
  ADMIN
}

// AI Generation Analytics Model
model AIGenerationLog {
  id                   String        @id @default(cuid())
  userId               String
  user                 User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  generationType       String        // 'recipe' or 'mealplan'
  success              Boolean       // Did validation pass?
  qualityScore         Float?        // Quality score at generation time
  defenseSystem        DefenseSystem?
  ingredientCount      Int?
  hasDietaryRestrictions Boolean     @default(false)
  hasMealType          Boolean       @default(false)
  validationErrors     String[]      // Array of validation error messages
  inputData            Json?         // Store the input parameters
  outputData           Json?         // Store the generated data (if successful)
  apiResponseTime      Int?          // Response time in milliseconds
  modelUsed            String?       // AI model version used
  tokensUsed           Int?          // Number of tokens consumed
  createdAt            DateTime      @default(now())
  
  @@index([userId])
  @@index([generationType])
  @@index([success])
  @@index([createdAt])
}

